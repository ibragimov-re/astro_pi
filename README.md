# Astro Pi

## Разработчики
Пермский национальный исследовательский политехнический университет, группа РИС-23-1бз
- [ibragimov-re](https://github.com/ibragimov-re) - Ибрагимов Руслан Эльнурович
- [NagoyaKei](https://github.com/NagoyaKei) - Горбунов Дмитрий Леонидович
- [GlebKrizhanovskii](https://github.com/GlebKrizhanovskii) Крижановский Глеб Глебович

## О проекте
Тема проекта: Разработка системы управления и наведения оптических приборов в экваториальных и азимутальных координатах.
Ссылка на проект: https://github.com/ibragimov-re/astro_pi

### Описание проекта
Работа состоит из двух частей:
1. Система наведения оптического прибора (экваториальная монтировка) представляет собой комплексное устройство, в котором микрокомпьютер Orange Pi 3 LTS используется в качестве основного управляющего блока. Аппаратная часть включает интегральную схему собственной разработки, состоящую из двух шаговых двигателей NEMA17, двух драйверов A4988, аккумуляторного блока 3S 18650 на 12 В, DC-DC преобразователя и платы контроля заряда.
Программная часть выполнена на Python и обеспечивает точное наведениеIO](https://opi-gpio.readthedocs.io), что позволяет реализовать стабильный и точный контроль за перемещением монтировки.
Такой подход обеспечивает автономную, компактную и высокоточную систему наведения для астрономических наблюдений в экваториальном режиме.
В дальнейших планах предусмотрена реализация полноценного сопровождения небесных объектов с автоматической компенсацией суточного вращения Земли, что позволит системе работать в режиме астрофотографического ведения.
2. Симулятор работы монтировки `KOPIS (Kompas-3D Orange Pi Simulator)` с графической визуализацией, использующий программу для моделирования деталей и сборок - [Компас-3D](https://kompas.ru/), который позволяет проектировать и тестировать работу будущего физического разрабатываемого устройства. Симулятор представляет собой библиотеку для python, которая имеет возможность подменять методы библиотеки [Opi.GPIO](https://opi-gpio.readthedocs.io) для работы с физическим устройством. Библиотека предоставляет возможность управлять GPIO-пинами и управлять шаговыми моторами в симуляторе. Сборкой, созданной в [Компас-3D](https://kompas.ru/) управляет программа, написанная на C++ и обернутая в библиотеку для python с помощью инструмента [pybind](https://github.com/pybind/pybind11). Сборка модуля для python происходит с использованием [cmake](https://cmake.org/).

![Mount](https://github.com/user-attachments/assets/b2c47602-12f3-4bb4-8832-0dc9b54b399c)
![Pins](https://github.com/user-attachments/assets/0803b22e-c01b-41af-a085-d1497a1ab169)

Получение координат небесных тел осуществляется через свободный виртуальный планетарий [Stellarium](https://stellarium.org/). Астрономические расчёты разработаны на основе формул из книг Jean Meeus – «Astronomical Algorithms» и П. Даффет-Смит «Практическая астрономия с калькулятором».
Поддерживается интеграция с внешними каталогами (Messier, NGC), а также прямое управление шаговыми двигателями.
Проект ориентирован на исследователей и астрофотографов, предлагая открытое и гибкое решение для автоматизации наблюдений.

### Принципиальная схема проекта
<img width="974" height="974" alt="image" src="https://github.com/user-attachments/assets/7668d216-dc3d-4e76-932b-e82a77ef5beb" />

### Структура проекта
/doc/ – документация;\
/simulation/ – симулятор;\
/src/ – исходный код (сервер, протоколы, точка входа);\
/test/ – тесты;\
/start.sh – скрипт запуска;\
/pullToDevice.sh – скрипт для копирования кода на устройство;\
/astropi.service – systemd unit-файл (для запуска как сервиса);\
/setup.py – скрипт установки пакета.

### Функции библиотеки `KOPIS` для управления монтировкой в симуляции через Python
`setmode(mode)` – установка режима нумерации пинов;\
`getmode()` – получение режима нумерации пинов;\
`setup(pinNumber, GpioMode mode)` – установка выбранного по номеру пина в режим IMPUT или OUTPUT;\
`setup(socName, mode)` – установка выбранного по имени пина в режим INPUT или OUTPUT;\
`output(pinNumber, state)` – установка возвращаемого значения для выбранного по номеру пина;\
`output (socName, state)` – установка возвращаемого значения для выбранного по значению пина;\
`output(pinNumber, value)` – установка value в качестве возвращаемого значения для выбранного по номеру пина;\
`output(socName, value)` – установка value в качестве возвращаемого значения для выбранного по имени пина;\
`setwarnings(isWarningsSet)` – включение/выключение вывода предупреждений;\
`cleanup()` – очистка  всех пинов;\
`cleanup (socName)` – установка значения по умолчанию для выбранного (по имени) пина;

### Подмодуль kopis_motorsim (функции для моторов)
`setup_motors_by_mount_type(type)`– возврат моторов в положение по умолчанию в зависимости от выбранного типа монтировки (для азимутальной 0° горизонтально и 0° вертикально, для экваториальной 0° горизонтально и 90° вертикально);\
`move_degrees(motorName, angle, speed)` – управление выбранным (по имени) шаговым двигателем;\
`reset_angle(motorName)` – возврат положения двигателя в положение по умолчанию (на угол 0 градусов);

### Подмодуль kopis_extra (дополнительные функции)
`test_gpio_pins()`– запуск тестовой программы для GPIO-пинов;\
`test_motors()`– запуск тестовой программы для шаговых двигателей;\
`print_board_pins()`– вывод в консоль таблицы с информацией обо всех пинах.

### Диаграмма состояния пинов в симуляторе `KOPIS`
<img width="680" height="491" alt="Pin Color Definitions" src="https://github.com/user-attachments/assets/06b86959-0086-4d0c-b5f9-b6c2f987b4c8" />

---

## Запуск программы-сервера для физического устройства (монтировки)
> [!IMPORTANT]
> Запуск сервера для физического устройства возможен только на устройствах Orange Pi
1. Скопировать необходимые файлы на устройство в директорию `/home/astropi` через скрипт
```shell
./pullToDevice.sh
```
Или перенести вручную всю директорию `src` и `main.py` на orange pi, в директорию `/home/astropi`
```shell
ssh root@orangepi3-lts "mkdir -p /home/astropi"; # create folder
```
```shell
scp -rp ./src ./start.sh root@orangepi3-lts:/home/astropi/ # copy src and start.sh to device
```
2. Запустить сервер через скрипт
```shell
./start.sh
```
Или вручную, с указанием протокола (по-умолчанию nexstar)
```shell
python3 -m src.main -r nexstar
```

---

## Запуск программы-сервера в режиме симуляции устройства (монтировки)
> [!IMPORTANT]
> Запуск сервера для симулятора возможен только на ПК с Windows и установленным Компас-3D V23+
1. Скачать [сборку экваториальной монтировки для Компас-3D](https://github.com/ibragimov-re/astro_pi/releases/tag/EQ_Mount_Assembly_v1.0), открыть файл сборки `Экваториальная монтировка для телескопа.a3d`.
2. Скачать разработанную для python [библиотеку-симулятор - KOPIS](https://github.com/ibragimov-re/astro_pi/releases/tag/Kopis_python_module), положить `.pyd` файл в корень проекта.
3. Установить вспомогательную библиотеку `astropy`
```shell
pip3 install astropy
```
4. Запустить сервер через скрипт
```shell
.\start_sim.bat
```
Или вручную, с указанием протокола (по-умолчанию `nexstar`) и с указанием режима симуляции `-t sim`
```shell
python3 -m src.main -r nexstar -t sim
```

---

## Подключение к серверу и управление монтировкой
> [!NOTE]
> Устройства должны быть в одной локальной сети, можно раздать Wi-Fi с телефона

### Подключение и управление монтировкой через Android-приложение `Stellarium Plus`
1. В приложении нажать на значок меню -> `Observing Tools` -> Включить `Telescope Control` -> закрыть меню.
2. Раскрыть появившееся снизу меню -> Type - `Network` -> в поля `Host` и `Port` ввести значения, выведенные сервером -> включить `Link`.
3. После подключения устройства свернуть меню -> выбрать любой небесный объект -> нажать `GOTO`.
4. Для отключения сервера: в терминале нажать комбинацию `Ctrl + C`.

### Подключение и управление монтировкой через Desktop-приложение `Stellarium` и `Virtual Serial Ports Emulator`
1. Для подключения через Desktop-приложение потребуется эмуляция виртуального COM-порта, поэтому необходимо установить [VSPE](https://eterlogic.com/Products.VSPE.html), подойдет бесплатная версия, необходимо будет при запуске нажать `Continue (with limitations)`.
2. В VSPE создать виртуальный разъем: `Create new device...` -> Device type - `Virtual Connector` -> `Next` -> Virtual COM Port - `COM2` -> `Finish`.
3. В VSPE создать TCP Клиент: `Create new device...` -> Device type - `TCP Client` -> `Next` -> выбрать `COM2` -> Поменять `TCP Data Port` на порт, указанный в выводе сервера -> `Finish`.
4. В Stellarium зайти в `Configuration Window (F2)` -> `Plugins` -> `Telescope Control` -> поставить галочку `Load at startup` -> `configure`.
5. После установки плагина перезапустить Stellarium -> зайти в `Move a telescope to a given set of coordinates (Ctrl + 0)` -> `Configure telescopes...` -> `Add a new telescope` -> Serial port - `COM2` -> `OK` -> `Start` -> закрыть окно `Telescopes`.
6. Выбрать любой небесный объект -> в окне `Slew telescope to (Ctrl + 0)` нажать `Current object`, затем `Slew`.
7. Для отключения сервера: в VSPE нажать ПКМ по `TpcClient: TPC...` -> `Stop device` -> в терминале нажать комбинацию `Ctrl + C`.
