# Astro Pi

## Разработчики
Пермский национальный исследовательский политехнический университет, группа РИС-23-1бз
- [ibragimov-re](https://github.com/ibragimov-re) - Ибрагимов Руслан Эльнурович
- [NagoyaKei](https://github.com/NagoyaKei) - Горбунов Дмитрий Леонидович
- [GlebKrizhanovskii](https://github.com/GlebKrizhanovskii) Крижановский Глеб Глебович

## О проекте
Тема проекта: Разработка системы управления и наведения оптических приборов в экваториальных и азимутальных координатах.
Ссылка на проект: https://github.com/ibragimov-re/astro_pi

### Описание проекта
Работа состоит из двух частей:
1. Система наведения оптического прибора (экваториальная монтировка) представляет собой комплексное устройство, в котором микрокомпьютер Orange Pi 3 LTS используется в качестве основного управляющего блока. Аппаратная часть включает интегральную схему собственной разработки, состоящую из двух шаговых двигателей NEMA17, двух драйверов A4988, аккумуляторного блока 3S 18650 на 12 В, DC-DC преобразователя и платы контроля заряда.
Программная часть выполнена на Python и обеспечивает точное наведение и сопровождение телескопа по экваториальным координатам (RA/Dec) с учётом компенсации суточного вращения Земли. Управление драйверами шаговых двигателей осуществляется с использованием библиотеки Opi.GPIO, что позволяет реализовать стабильный и точный контроль за перемещением монтировки.
Такой подход обеспечивает автономную, компактную и высокоточную систему наведения для астрономических наблюдений в экваториальном режиме.
В дальнейших планах предусмотрена реализация полноценного сопровождения небесных объектов с автоматической компенсацией суточного вращения Земли, что позволит системе работать в режиме астрофотографического ведения.. Для управления двигателями используется библиотека OPi.GPIO
2. Симулятор работы монтировки с графическим изображением, разработанным в КОМПАС-3D, позволяющим моделировать и тестировать работу устройства. Методы программы дублируют методы библиотеки OPi.GPIO, написаны на С++ и используются в python-скрипте через библиотеку Pybind11 (https://pybind11.readthedocs.io/en/stable/index.html#) с помощью	системы сборки кроссплатформенного программного обеспечения CMake (https://cmake.org/). 
	Получение координат небесных тел осуществляется через свободный виртуальный планетарий Stellarium (https://stellarium.org/). Астрономические расчёты разработаны на основе формул из книг Jean Meeus – «Astronomical Algorithms» и П. Даффет-Смит «Практическая астрономия с калькулятором», поддерживается интеграция с внешними каталогами (Messier, NGC), а также прямое управление шаговыми двигателями.
	Проект ориентирован на исследователей и астрофотографов, предлагая открытое и гибкое решение для автоматизации наблюдений.

### Принципиальная схема проекта
<img width="974" height="974" alt="image" src="https://github.com/user-attachments/assets/7668d216-dc3d-4e76-932b-e82a77ef5beb" />

### Структура проекта
/doc/ – документация;\
/simulation/ – симулятор;\
/src/ – исходный код (сервер, протоколы, точка входа);\
/test/ – тесты;\
/start.sh – скрипт запуска;\
/pullToDevice.sh – скрипт для копирования кода на устройство;\
/astropi.service – systemd unit-файл (для запуска как сервиса);\
/setup.py – скрипт установки пакета.

### Функции библиотеки kopis для управления монтировкой в симуляции через Python
```setmode(mode)```– установка режима нумерации пинов;\
```getmode()``` – получение режима нумерации пинов;\
```setup(pinNumber, GpioMode mode)``` – установка выбранного по номеру пина в режим IMPUT или OUTPUT;\
```setup(socName, mode)``` – установка выбранного по имени пина в режим INPUT или OUTPUT;\
```output(pinNumber, state)``` – установка возвращаемого взачения для выбранного по номеру пина;\
```output (socName, state)``` – установка возвращаемого взачения для выбранного по значению пина;\
```output(pinNumber, value)``` – установка value в качестве возвращаемого взачения для выбранного по номеру пина;\
```output(socName, value)``` – установка value в качестве возвращаемого взачения для выбранного по имени пина;\
```setwarnings(isWarningsSet)``` – включение/выключение вывода предупреждений;\
```cleanup()``` – очистка  всех пинов;\
```cleanup (socName)``` – установка значения по умолчанию для выбранного (по имени) пина;\

### Подмодуль kopis_motorsim (функции для моторов)
```setup_motors_by_mount_type(type)```– возврат моторов в положение по умолчанию в зависимости от выбранного типа монтировки (для азимутальной 0° горизонтально и 0° вертикально, для экваториальной 0° горизонтально и 90° вертикально);\
```move_degrees(motorName, angle, speed)``` – управление выбранным (по имени) шаговым двигателем;\
```reset_angle(motorName)``` – возврат положения двигателя в положение по умолчанию (на угол 0 градусов);\

### Подмодуль kopis_extra (дополнительные функции)
```test_gpio_pins()```– запуск тестовой программы для GPIO-пинов;\
```test_motors()```– запуск тестовой программы для шаговых двигателей;\
```print_board_pins()```– вывод в консоль таблицы с информацией обо всех пинах.\

### Подмодуль kopis_extra (дополнительные функции)
```test_gpio_pins()```– запуск тестовой программы для GPIO-пинов;\
```test_motors()``` – запуск тестовой программы для шаговых двигателей;\
```print_board_pins()```– вывод в консоль таблицы с информацией обо всех пинах.\

### Диаграмма состояния пинов в симуляторе
<img width="534" height="351" alt="image" src="https://github.com/user-attachments/assets/a2de7d14-7950-4b5e-8352-8a0935801868" />



### Как запустить?


1. Перенести всю папку `src` и `main.py` на orange pi в папку `~/home/astropi`
```shell
ssh root@orangepi3-lts "mkdir -p /home/astropi";          # create folder
```


```shell
scp -rp ./src ./start.sh root@orangepi3-lts:/home/astropi/ # copy src and start.sh to device
```
или выполнить скрипт `pullToOrangePi.sh`

2. Запустить сервер через `main.py` с указанием протокола (по-умолчанию `nexstar`), например: `python3 -m src.main -r nexstar`
 
### Как подключится?

1. Устройства должны быть в одной локальной сети (можно раздать wi-fi с телефона)
2. Заходим в Stellarium и выбираем в меню "Инструменты наблюдения" -> "Управление телескопом"
3. В хост вписываем IP адрес монтировки или имя (имя устройства обычно `orange-pi3`)
4. Вписываем порт, зависит от протокола: 
   - LX200: `4030` 
   - NexStar:`4030`
   - Stellarium:`10001` (скоро)
   - RTS2: `8889` (скоро)
   - SynScan: `11882` (скоро)
5. Подключаемся
